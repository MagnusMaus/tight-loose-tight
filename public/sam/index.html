<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sam - Karriere-Coach</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        #root {
            width: 100%;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        const { createRoot } = ReactDOM;

        // Lucide icons
        const SendIcon = () => (
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        );

        const FileUpIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="12" y1="18" x2="12" y2="12"></line>
                <line x1="9" y1="15" x2="15" y2="15"></line>
            </svg>
        );

        const CheckCircleIcon = () => (
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        );

        const BookmarkPlusIcon = () => (
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m19 21-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                <line x1="12" y1="7" x2="12" y2="13"></line>
                <line x1="9" y1="10" x2="15" y2="10"></line>
            </svg>
        );

        const Trash2Icon = () => (
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        const SearchIcon = () => (
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
        );

        const UploadIcon = () => (
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
        );

        const SamCareerCoach = () => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [jobCards, setJobCards] = useState([]);
            const [savedJobs, setSavedJobs] = useState([]);
            const [showSavedJobs, setShowSavedJobs] = useState(false);
            const [isSearchingJobs, setIsSearchingJobs] = useState(false);
            const [isUploadingCV, setIsUploadingCV] = useState(false);
            
            // 🔧 FIX: Verwende useRef statt nur State für shown jobs
            // Damit haben wir SOFORT den aktuellen Wert, auch in async Funktionen!
            const shownJobUrlsRef = useRef(new Set());
            const [shownJobUrls, setShownJobUrls] = useState(new Set());
            
            const messagesEndRef = useRef(null);
            const fileInputRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages, jobCards]);

            useEffect(() => {
                // Initial message
                setMessages([{
                    role: 'assistant',
                    content: 'Hey! Ich bin Sam, dein KI-Karriere-Coach. Erzähl mir, welche berufliche Entwicklung du dir vorstellst, und ich helfe dir, die perfekte Stelle zu finden. 🚀'
                }]);
            }, []);

            // Helper function zum Hinzufügen von Jobs zu "shown"
            const addJobToShown = (jobKey) => {
                console.log(`🔖 Adding job to shown list: "${jobKey}"`);
                // Update BEIDE: Ref (sofort!) und State (für UI)
                shownJobUrlsRef.current.add(jobKey);
                setShownJobUrls(new Set(shownJobUrlsRef.current));
                console.log(`✅ Total shown jobs: ${shownJobUrlsRef.current.size}`);
            };

            // Helper function zum Checken ob Job schon gezeigt wurde
            const isJobAlreadyShown = (jobKey) => {
                return shownJobUrlsRef.current.has(jobKey);
            };

            // Parse JOB_CARD aus Sam's Response
            const parseJobCard = (text) => {
                console.log('🔍 parseJobCard() called');
                console.log(`   Input length: ${text.length} chars`);
                
                const cardMatch = text.match(/\[JOB_CARD:(\{[\s\S]*?\})\]/);
                if (!cardMatch) {
                    console.log('   ❌ No [JOB_CARD:{...}] pattern found in text');
                    console.log('   First 200 chars:', text.substring(0, 200));
                    return null;
                }
                
                console.log('   ✅ [JOB_CARD:{...}] pattern found!');
                console.log('   Raw JSON:', cardMatch[1].substring(0, 200) + '...');
                
                try {
                    const jobData = JSON.parse(cardMatch[1]);
                    console.log('   ✅ JSON parsed successfully!');
                    console.log('   Job title:', jobData.title);
                    console.log('   Company:', jobData.company);
                    console.log('   Fit score:', jobData.fitScore);
                    
                    const cleanText = text.replace(/\[JOB_CARD:[\s\S]*?\]/, '').trim();
                    console.log('   Clean text length:', cleanText.length, 'chars');
                    
                    return { jobData, cleanText };
                } catch (e) {
                    console.error('   ❌ Failed to parse JOB_CARD JSON:', e);
                    return null;
                }
            };

            // Verarbeite Sam's Response und handle TRIGGER_SEARCH
            const processSamResponse = async (responseText, currentMessages) => {
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log('📥 DEBUG: processSamResponse called');
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log('📝 FULL SAM RESPONSE:');
                console.log(responseText);
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                
                // Check für TRIGGER_SEARCH
                console.log('🔍 DEBUG: Checking for TRIGGER_SEARCH...');
                const triggerSearchMatch = responseText.match(/\[TRIGGER_SEARCH:\s*(\{[^}]+\})\]/);
                console.log('   Found:', triggerSearchMatch ? 'YES ✅' : 'NO ❌');
                
                if (triggerSearchMatch) {
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    console.log('🔍 DEBUG: TRIGGER_SEARCH detected!');
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    console.log('📋 Raw JSON string:', triggerSearchMatch[1]);
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    
                    try {
                        const params = JSON.parse(triggerSearchMatch[1]);
                        console.log('✅ Parsed successfully:', params);
                        
                        // Extrahiere Text VOR dem TRIGGER_SEARCH
                        const cleanText = responseText.split('[TRIGGER_SEARCH:')[0].trim();
                        console.log('📝 Text BEFORE TRIGGER_SEARCH:');
                        console.log(cleanText);
                        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                        
                        // Zeige nur den sauberen Text (ohne den rohen TRIGGER_SEARCH Tag!)
                        if (cleanText) {
                            console.log('💬 Adding clean message to chat');
                            setMessages(prev => [...prev, { role: 'assistant', content: cleanText }]);
                        }
                        
                        // Starte Job-Suche
                        console.log('🚀 Starting job search with query:', params.query, 'location:', params.location);
                        await searchJobs(params.query, params.location, currentMessages);
                        
                    } catch (e) {
                        console.error('❌ Failed to parse TRIGGER_SEARCH:', e);
                        // Fallback: Zeige normale Nachricht
                        setMessages(prev => [...prev, { role: 'assistant', content: responseText }]);
                    }
                } else {
                    // Keine TRIGGER_SEARCH -> prüfe auf JOB_CARD
                    console.log('🔍 DEBUG: Checking for JOB_CARD...');
                    const parsed = parseJobCard(responseText);
                    console.log('   Found:', parsed ? 'YES ✅' : 'NO ❌');
                    
                    if (parsed) {
                        // JOB_CARD gefunden
                        console.log('💬 DEBUG: Adding message with JOB_CARD');
                        setMessages(prev => [...prev, { role: 'assistant', content: parsed.cleanText || responseText }]);
                    } else {
                        // Normale Nachricht
                        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                        console.log('💬 DEBUG: Normal message (no TRIGGER_SEARCH or JOB_CARD)');
                        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                        console.log('📝 Message content:', responseText.substring(0, 200) + '...');
                        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                        setMessages(prev => [...prev, { role: 'assistant', content: responseText }]);
                    }
                }
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            };

            // Generiere Query-Varianten für intelligente Suche
            const generateQueryVariants = (baseQuery) => {
                const words = baseQuery.trim().split(/\s+/);
                const variants = [baseQuery]; // Start mit original query
                
                // Kombinationen aus 2+ Wörtern
                if (words.length >= 2) {
                    const twoWords = `${words[0]} ${words[1]}`;
                    if (!variants.includes(twoWords)) variants.push(twoWords);
                }
                
                // Einzelne wichtige Wörter
                if (words.length >= 1 && words[0].length >= 4) {
                    if (!variants.includes(words[0])) variants.push(words[0]);
                }
                if (words.length >= 2 && words[1].length >= 4) {
                    if (!variants.includes(words[1])) variants.push(words[1]);
                }
                
                console.log('📊 Query variants:', variants);
                return variants;
            };

            // Generiere Location-Tiers für stufenweise Suche
            const generateLocationTiers = (baseLocation) => {
                const tiers = [
                    { location: baseLocation, radius: 50, label: 'Lokal' },
                    { location: baseLocation, radius: 100, label: 'Region' },
                    { location: baseLocation, radius: 200, label: 'Erweitert' },
                    { location: 'Berlin', radius: 50, label: 'Berlin' },
                    { location: 'München', radius: 50, label: 'München' },
                    { location: 'Hamburg', radius: 50, label: 'Hamburg' },
                    { location: 'Frankfurt', radius: 50, label: 'Frankfurt' },
                    { location: 'Deutschland', radius: 500, label: 'Bundesweit' }
                ];
                
                // Remove duplicates
                const seen = new Set();
                const uniqueTiers = tiers.filter(tier => {
                    const key = `${tier.location}-${tier.radius}`;
                    if (seen.has(key)) return false;
                    seen.add(key);
                    return true;
                });
                
                console.log('📍 Location tiers:', tiers);
                return tiers;
            };
            
            // Einzelner API-Call zur Arbeitsagentur
            const searchJobsAPI = async (query, location, radius) => {
                const response = await fetch('/.netlify/functions/search-jobs-arbeitsagentur', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        location: location,
                        radius: radius,
                        size: 25
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                return await response.json();
            };
            
            // Hauptfunktion: Intelligente gestaffelte Suche
            const searchJobs = async (query, location, currentMessages, retryCount = 0, triedSet = new Set()) => {
                console.log('🎯 Starting intelligent tiered search for:', query);
                
                setIsSearchingJobs(true);
                
                try {
                    // Generiere Query-Varianten und Location-Tiers
                    const queryVariants = generateQueryVariants(query);
                    const userRegion = location || 'Hannover'; // Default zu Hannover wenn keine Location
                    const locationTiers = generateLocationTiers(userRegion);
                    
                    let attemptNumber = 0;
                    let foundJobs = null;
                    
                    // Durchlaufe alle Kombinationen: Query-Varianten × Location-Tiers
                    for (const queryVariant of queryVariants) {
                        for (const locationTier of locationTiers) {
                            attemptNumber++;
                            
                            // Skip wenn diese Kombination schon probiert wurde
                            const comboKey = `${queryVariant}-${locationTier.location}-${locationTier.radius}`;
                            if (triedSet.has(comboKey)) {
                                console.log(`⏭️  Skipping already tried: ${comboKey}`);
                                continue;
                            }
                            triedSet.add(comboKey);
                            
                            console.log(`🔍 Attempt ${attemptNumber}: "${queryVariant}" in ${locationTier.location} (${locationTier.radius}km) [${locationTier.label}]`);
                            
                            try {
                                const data = await searchJobsAPI(queryVariant, locationTier.location, locationTier.radius);
                                console.log('📊 Result:', data.jobs?.length || 0, 'jobs found');
                                
                                if (data.jobs && data.jobs.length > 0) {
                                    // 🔧 FIX: Filtere bereits gezeigte Jobs SOFORT mit REF!
                                    console.log(`   📋 Total jobs from API: ${data.jobs.length}`);
                                    console.log(`   🔍 Already shown jobs: ${shownJobUrlsRef.current.size}`);
                                    
                                    const newJobs = data.jobs.filter(job => {
                                        const jobKey = job.url || `${job.title}_${job.company}`;
                                        const isNew = !isJobAlreadyShown(jobKey);
                                        if (!isNew) {
                                            console.log(`   ⏭️  Skipping already shown: "${job.title}" at ${job.company}`);
                                        }
                                        return isNew;
                                    });
                                    
                                    console.log(`   ✨ New jobs after filtering: ${newJobs.length}`);
                                    
                                    // Nur wenn NEUE Jobs nach Filterung -> als Erfolg werten
                                    if (newJobs.length > 0) {
                                        console.log(`🎉 SUCCESS! Found ${newJobs.length} NEW jobs!`);
                                        foundJobs = {
                                            jobs: newJobs,
                                            query: queryVariant,
                                            location: locationTier.location
                                        };
                                        break; // Erfolg - stop die innere Schleife
                                    } else {
                                        console.log('⚠️  All jobs were already shown - continuing search...');
                                        // Kein break - weitermachen mit nächster Kombination
                                    }
                                } else {
                                    console.log('📭 No jobs, trying next combination...');
                                }
                                
                            } catch (error) {
                                console.error(`❌ Error in attempt ${attemptNumber}:`, error);
                                // Continue mit nächster Kombination
                            }
                        }
                    }
                    
                    // Check ob Jobs gefunden wurden
                    if (!foundJobs) {
                        console.error('❌ All combinations exhausted - no jobs found');
                        setMessages(prev => [...prev, {
                            role: 'assistant',
                            content: `Ich habe sehr gründlich gesucht, aber leider keine passenden Stellen gefunden. Lass uns gemeinsam überlegen: Könnten wir das Suchprofil etwas anpassen? Vielleicht verwandte Rollen oder andere Branchen einbeziehen? 🤔`
                        }]);
                        setIsSearchingJobs(false);
                        return null;
                    }
                    
                    // Jobs gefunden! Sende an Sam zur Bewertung
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    console.log('📤 DEBUG: Sending jobs to Sam for ANALYSIS');
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    console.log(`   Jobs found: ${foundJobs.jobs.length}`);
                    console.log(`   Query: "${foundJobs.query}"`);
                    console.log(`   Location: "${foundJobs.location}"`);
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    
                    // Call Sam API
                    const updatedMessages = [...currentMessages, {
                        role: 'user',
                        content: `Ich habe ${foundJobs.jobs.length} passende Stellen gefunden für: "${query}". Hier ist der beste Match:\n\n${JSON.stringify(foundJobs.jobs[0], null, 2)}\n\nAnalysiere diese Position und erstelle eine JOB_CARD mit deiner Bewertung. Fokussiere auf den ersten Job!`
                    }];
                    
                    try {
                        console.log('🌐 Calling Sam API for job analysis...');
                        const samResponse = await fetch('/.netlify/functions/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                messages: updatedMessages,
                                conversationContext: {
                                    hasCV: messages.some(m => m.role === 'user' && m.content.includes('UPLOADED_CV')),
                                    previousJobs: jobCards.map(j => j.title)
                                }
                            })
                        });
                        
                        console.log('✅ API Response received! Status:', samResponse.status);
                        
                        if (!samResponse.ok) {
                            throw new Error(`Sam API error: ${samResponse.status}`);
                        }
                        
                        const samData = await samResponse.json();
                        console.log('📦 Response JSON parsed successfully');
                        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                        console.log('🤖 SAM\'S ANALYSIS RESPONSE:');
                        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                        const assistantMessage = samData.content[0].text;
                        console.log(assistantMessage);
                        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                        console.log('📏 Response length:', assistantMessage.length, 'characters');
                        console.log('🔍 Checking if response contains JOB_CARD...');
                        
                        const parsed = parseJobCard(assistantMessage);
                        console.log('🎯 parseJobCard result:', parsed ? 'FOUND JOB_CARD ✅' : 'NO JOB_CARD ❌');
                        
                        if (parsed) {
                            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                            console.log('✨ Creating JOB_CARD!');
                            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                            console.log('📋 Job Data:', JSON.stringify(parsed.jobData, null, 2));
                            console.log('💬 Clean Text:', parsed.cleanText ? parsed.cleanText.substring(0, 100) + '...' : '(none)');
                            
                            const newCard = { ...parsed.jobData, id: Date.now() };
                            console.log('🆔 Card ID:', newCard.id);
                            console.log('🏢 Job Title:', newCard.title);
                            console.log('🔗 Job URL:', newCard.applyUrl || newCard.url || '(no URL)');
                            
                            setJobCards(prev => {
                                console.log('📊 Current jobCards count:', prev.length);
                                console.log('➕ Adding new card, new count will be:', prev.length + 1);
                                return [...prev, newCard];
                            });
                            
                            // 🔧 FIX: Tracke diese Job-URL als "gezeigt" mit Helper Function
                            const jobKey = parsed.jobData.applyUrl || parsed.jobData.url || `${parsed.jobData.title}_${parsed.jobData.company}`;
                            addJobToShown(jobKey);
                            
                            if (parsed.cleanText) {
                                console.log('💬 Adding Sam\'s analysis message to chat');
                                setMessages(prev => [...prev, { role: 'assistant', content: parsed.cleanText }]);
                            }
                            console.log('✅ JOB_CARD successfully added to UI!');
                            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                        } else {
                            // 🔧 FIX 2: Check ob Sam einen TRIGGER_SEARCH zurückgegeben hat!
                            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                            console.log('⚠️  NO JOB_CARD FOUND in response!');
                            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                            
                            // Check ob Response einen TRIGGER_SEARCH enthält
                            if (assistantMessage.includes('[TRIGGER_SEARCH:')) {
                                console.log('🔍 Response contains TRIGGER_SEARCH - Sam wants to search differently!');
                                console.log('📝 Processing TRIGGER_SEARCH via processSamResponse...');
                                
                                // WICHTIG: Nutze processSamResponse um TRIGGER_SEARCH richtig zu verarbeiten!
                                const messagesWithResponse = [...updatedMessages, { role: 'assistant', content: assistantMessage }];
                                await processSamResponse(assistantMessage, messagesWithResponse);
                                console.log('✅ TRIGGER_SEARCH processed successfully!');
                            } else {
                                console.log('📝 Adding Sam\'s message as normal text (no card, no TRIGGER_SEARCH)');
                                console.log('Message preview:', assistantMessage.substring(0, 200) + '...');
                                setMessages(prev => [...prev, { role: 'assistant', content: assistantMessage }]);
                                console.log('⚠️  This is unexpected - Sam should have created a JOB_CARD!');
                            }
                            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                        }
                        
                        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                        console.log('🏁 searchJobs() completed successfully!');
                        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                        setIsSearchingJobs(false);
                        return foundJobs.jobs;

                    } catch (error) {
                        console.error('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                        console.error('❌ CRITICAL ERROR in searchJobs!');
                        console.error('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                        console.error('Error type:', error.name);
                        console.error('Error message:', error.message);
                        console.error('Error stack:', error.stack);
                        console.error('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                        
                        setMessages(prev => [...prev, {
                            role: 'assistant',
                            content: `Entschuldigung, da ist ein technisches Problem aufgetreten: ${error.message}. Lass uns es nochmal versuchen! 🔧`
                        }]);
                        setIsSearchingJobs(false);
                        return null;
                    }
                } catch (error) {
                    console.error('Critical search error:', error);
                    setMessages(prev => [...prev, {
                        role: 'assistant',
                        content: 'Entschuldigung, bei der Jobsuche ist ein Fehler aufgetreten. Lass es uns nochmal versuchen! 🔧'
                    }]);
                    setIsSearchingJobs(false);
                    return null;
                }
            };

            const sendMessage = async () => {
                if (!input.trim() || isLoading) return;

                const userMessage = { role: 'user', content: input };
                const updatedMessages = [...messages, userMessage];
                setMessages(updatedMessages);
                setInput('');
                setIsLoading(true);

                try {
                    const response = await fetch('/.netlify/functions/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            messages: updatedMessages,
                            conversationContext: {
                                hasCV: messages.some(m => m.role === 'user' && m.content.includes('UPLOADED_CV')),
                                previousJobs: jobCards.map(j => j.title)
                            }
                        })
                    });

                    if (!response.ok) throw new Error('Network response was not ok');

                    const data = await response.json();
                    const assistantMessage = data.content[0].text;

                    await processSamResponse(assistantMessage, updatedMessages);

                } catch (error) {
                    console.error('Error:', error);
                    setMessages(prev => [...prev, {
                        role: 'assistant',
                        content: 'Entschuldigung, da ist etwas schiefgelaufen. Versuch es nochmal! 🔧'
                    }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleJobAction = async (cardId, action) => {
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log('🎯 DEBUG: handleJobAction called');
                console.log(`   Card ID: ${cardId}`);
                console.log(`   Action: ${action}`);
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                
                const card = jobCards.find(c => c.id === cardId);
                if (!card) return;

                // Remove from visible job cards
                setJobCards(prev => prev.filter(c => c.id !== cardId));

                // Handle different actions
                if (action === 'save') {
                    setSavedJobs(prev => [...prev, card]);
                } else if (action === 'apply') {
                    window.open(card.applyUrl, '_blank');
                    setSavedJobs(prev => [...prev, { ...card, applied: true }]);
                }

                // Ask Sam for feedback and next job
                const updatedMessages = [...messages, {
                    role: 'user',
                    content: action === 'save' 
                        ? `Ich habe die Position "${card.title}" bei ${card.company} gespeichert. Zeig mir weitere passende Stellen! 🔍`
                        : action === 'reject'
                        ? `Die Position "${card.title}" bei ${card.company} passt nicht so gut. Such weiter! 🔍`
                        : `Ich habe mich auf "${card.title}" bei ${card.company} beworben! Zeig mir weitere passende Stellen! 🚀`
                }];

                setMessages(updatedMessages);
                setIsLoading(true);

                try {
                    const response = await fetch('/.netlify/functions/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            messages: updatedMessages,
                            conversationContext: {
                                hasCV: messages.some(m => m.role === 'user' && m.content.includes('UPLOADED_CV')),
                                previousJobs: jobCards.map(j => j.title),
                                lastAction: action,
                                lastJob: card
                            }
                        })
                    });

                    if (!response.ok) throw new Error('Network response was not ok');

                    const data = await response.json();
                    const assistantMessage = data.content[0].text;
                    
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    console.log('📨 DEBUG: Sam response after handleJobAction:');
                    console.log('   Context: After user clicked', action);
                    console.log('   Expected: TRIGGER_SEARCH (if save/reject) or normal text (if apply)');
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

                    await processSamResponse(assistantMessage, updatedMessages);

                } catch (error) {
                    console.error('Error in handleJobAction:', error);
                    setMessages(prev => [...prev, {
                        role: 'assistant',
                        content: 'Entschuldigung, da ist etwas schiefgelaufen. Lass uns weitermachen! 💪'
                    }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleCVUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                console.log('📄 CV upload started');
                setIsUploadingCV(true);

                try {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const cvContent = e.target.result;

                        const updatedMessages = [...messages, {
                            role: 'user',
                            content: `UPLOADED_CV: ${file.name}\n\nCV Content: ${cvContent.substring(0, 3000)}...`
                        }];

                        setMessages(prev => [...prev, {
                            role: 'user',
                            content: `📄 Ich habe meinen Lebenslauf hochgeladen: ${file.name}`
                        }]);

                        const response = await fetch('/.netlify/functions/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                messages: updatedMessages,
                                conversationContext: {
                                    hasCV: true,
                                    previousJobs: jobCards.map(j => j.title)
                                }
                            })
                        });

                        if (!response.ok) throw new Error('Network response was not ok');

                        const data = await response.json();
                        await processSamResponse(data.content[0].text, updatedMessages);
                    };

                    reader.readAsText(file);

                } catch (error) {
                    console.error('Error uploading CV:', error);
                    setMessages(prev => [...prev, {
                        role: 'assistant',
                        content: 'Entschuldigung, beim Hochladen deines Lebenslaufs ist etwas schiefgelaufen. Versuch es nochmal! 📄'
                    }]);
                } finally {
                    setIsUploadingCV(false);
                }
            };

            return (
                <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    height: '100vh',
                    backgroundColor: '#f8f9fa'
                }}>
                    {/* Header */}
                    <div style={{
                        padding: '20px',
                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        color: 'white',
                        boxShadow: '0 2px 10px rgba(0,0,0,0.1)',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center'
                    }}>
                        <div>
                            <h1 style={{ margin: 0, fontSize: '24px', fontWeight: '600' }}>Sam - Karriere-Coach</h1>
                            <p style={{ margin: '5px 0 0 0', fontSize: '14px', opacity: 0.9 }}>Dein persönlicher KI-Karriere-Berater 🚀</p>
                        </div>
                        <button
                            onClick={() => setShowSavedJobs(!showSavedJobs)}
                            style={{
                                padding: '10px 20px',
                                backgroundColor: 'rgba(255,255,255,0.2)',
                                border: 'none',
                                borderRadius: '8px',
                                color: 'white',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px',
                                fontSize: '14px',
                                fontWeight: '500',
                                transition: 'background-color 0.2s'
                            }}
                            onMouseEnter={(e) => e.target.style.backgroundColor = 'rgba(255,255,255,0.3)'}
                            onMouseLeave={(e) => e.target.style.backgroundColor = 'rgba(255,255,255,0.2)'}
                        >
                            <BookmarkPlusIcon />
                            Gespeicherte Jobs ({savedJobs.length})
                        </button>
                    </div>

                    {/* Saved Jobs Panel */}
                    {showSavedJobs && (
                        <div style={{
                            padding: '20px',
                            backgroundColor: 'white',
                            borderBottom: '1px solid #e0e0e0',
                            maxHeight: '300px',
                            overflowY: 'auto'
                        }}>
                            <h3 style={{ margin: '0 0 15px 0', color: '#333' }}>Gespeicherte Stellen</h3>
                            {savedJobs.length === 0 ? (
                                <p style={{ color: '#666', fontStyle: 'italic' }}>Noch keine gespeicherten Stellen</p>
                            ) : (
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                                    {savedJobs.map((job, index) => (
                                        <div key={index} style={{
                                            padding: '15px',
                                            backgroundColor: '#f8f9fa',
                                            borderRadius: '8px',
                                            border: '1px solid #e0e0e0'
                                        }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                                                <div>
                                                    <h4 style={{ margin: '0 0 5px 0', color: '#333' }}>{job.title}</h4>
                                                    <p style={{ margin: '0 0 5px 0', color: '#666', fontSize: '14px' }}>{job.company}</p>
                                                    <p style={{ margin: 0, color: '#999', fontSize: '13px' }}>{job.location}</p>
                                                    {job.applied && (
                                                        <span style={{
                                                            display: 'inline-block',
                                                            marginTop: '5px',
                                                            padding: '4px 8px',
                                                            backgroundColor: '#4CAF50',
                                                            color: 'white',
                                                            borderRadius: '4px',
                                                            fontSize: '12px'
                                                        }}>
                                                            ✓ Beworben
                                                        </span>
                                                    )}
                                                </div>
                                                <button
                                                    onClick={() => window.open(job.applyUrl, '_blank')}
                                                    style={{
                                                        padding: '8px 16px',
                                                        backgroundColor: '#667eea',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '6px',
                                                        cursor: 'pointer',
                                                        fontSize: '14px',
                                                        fontWeight: '500'
                                                    }}
                                                >
                                                    Öffnen
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Chat Messages */}
                    <div style={{
                        flex: 1,
                        overflowY: 'auto',
                        padding: '20px',
                        display: 'flex',
                        flexDirection: 'column',
                        gap: '15px'
                    }}>
                        {messages.map((message, index) => (
                            <div
                                key={index}
                                style={{
                                    display: 'flex',
                                    justifyContent: message.role === 'user' ? 'flex-end' : 'flex-start'
                                }}
                            >
                                <div style={{
                                    maxWidth: '70%',
                                    padding: '12px 16px',
                                    borderRadius: '12px',
                                    backgroundColor: message.role === 'user' ? '#667eea' : 'white',
                                    color: message.role === 'user' ? 'white' : '#333',
                                    boxShadow: '0 2px 5px rgba(0,0,0,0.1)',
                                    whiteSpace: 'pre-wrap',
                                    wordWrap: 'break-word'
                                }}>
                                    {message.content}
                                </div>
                            </div>
                        ))}

                        {/* Job Cards */}
                        {jobCards.map((card) => (
                            <div key={card.id} style={{
                                backgroundColor: 'white',
                                borderRadius: '12px',
                                padding: '20px',
                                boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                border: '2px solid #667eea'
                            }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '15px' }}>
                                    <div style={{ flex: 1 }}>
                                        <h3 style={{ margin: '0 0 8px 0', color: '#333', fontSize: '18px' }}>{card.title}</h3>
                                        <p style={{ margin: '0 0 5px 0', color: '#666', fontSize: '14px' }}>{card.company}</p>
                                        <p style={{ margin: '0 0 5px 0', color: '#999', fontSize: '13px' }}>{card.location}</p>
                                        {card.salary && <p style={{ margin: 0, color: '#4CAF50', fontSize: '14px', fontWeight: '500' }}>{card.salary}</p>}
                                    </div>
                                    <div style={{
                                        padding: '8px 16px',
                                        backgroundColor: card.fitScore >= 80 ? '#4CAF50' : card.fitScore >= 60 ? '#FF9800' : '#666',
                                        color: 'white',
                                        borderRadius: '20px',
                                        fontWeight: 'bold',
                                        fontSize: '14px'
                                    }}>
                                        {card.fitScore}% Match
                                    </div>
                                </div>

                                <p style={{ margin: '0 0 15px 0', color: '#555', fontSize: '14px', lineHeight: '1.6' }}>
                                    {card.description}
                                </p>

                                {card.pros && card.pros.length > 0 && (
                                    <div style={{ marginBottom: '15px' }}>
                                        <h4 style={{ margin: '0 0 8px 0', color: '#4CAF50', fontSize: '14px' }}>✓ Vorteile:</h4>
                                        <ul style={{ margin: 0, paddingLeft: '20px', color: '#555', fontSize: '13px' }}>
                                            {card.pros.map((pro, idx) => <li key={idx}>{pro}</li>)}
                                        </ul>
                                    </div>
                                )}

                                {card.cons && card.cons.length > 0 && (
                                    <div style={{ marginBottom: '15px' }}>
                                        <h4 style={{ margin: '0 0 8px 0', color: '#FF5722', fontSize: '14px' }}>⚠ Zu beachten:</h4>
                                        <ul style={{ margin: 0, paddingLeft: '20px', color: '#555', fontSize: '13px' }}>
                                            {card.cons.map((con, idx) => <li key={idx}>{con}</li>)}
                                        </ul>
                                    </div>
                                )}

                                <div style={{ display: 'flex', gap: '10px', marginTop: '15px' }}>
                                    <button
                                        onClick={() => handleJobAction(card.id, 'apply')}
                                        style={{
                                            flex: 1,
                                            padding: '12px',
                                            backgroundColor: '#4CAF50',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            gap: '8px',
                                            fontSize: '14px',
                                            fontWeight: '500',
                                            transition: 'background-color 0.2s'
                                        }}
                                        onMouseEnter={(e) => e.target.style.backgroundColor = '#45a049'}
                                        onMouseLeave={(e) => e.target.style.backgroundColor = '#4CAF50'}
                                    >
                                        <CheckCircleIcon />
                                        Bewerben
                                    </button>
                                    <button
                                        onClick={() => handleJobAction(card.id, 'save')}
                                        style={{
                                            flex: 1,
                                            padding: '12px',
                                            backgroundColor: '#667eea',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            gap: '8px',
                                            fontSize: '14px',
                                            fontWeight: '500',
                                            transition: 'background-color 0.2s'
                                        }}
                                        onMouseEnter={(e) => e.target.style.backgroundColor = '#5568d3'}
                                        onMouseLeave={(e) => e.target.style.backgroundColor = '#667eea'}
                                    >
                                        <BookmarkPlusIcon />
                                        Speichern
                                    </button>
                                    <button
                                        onClick={() => handleJobAction(card.id, 'reject')}
                                        style={{
                                            flex: 1,
                                            padding: '12px',
                                            backgroundColor: '#f44336',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            gap: '8px',
                                            fontSize: '14px',
                                            fontWeight: '500',
                                            transition: 'background-color 0.2s'
                                        }}
                                        onMouseEnter={(e) => e.target.style.backgroundColor = '#da190b'}
                                        onMouseLeave={(e) => e.target.style.backgroundColor = '#f44336'}
                                    >
                                        <Trash2Icon />
                                        Ablehnen
                                    </button>
                                </div>
                            </div>
                        ))}

                        {isSearchingJobs && (
                            <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px',
                                padding: '15px',
                                backgroundColor: 'white',
                                borderRadius: '12px',
                                boxShadow: '0 2px 5px rgba(0,0,0,0.1)'
                            }}>
                                <SearchIcon />
                                <span style={{ color: '#666' }}>Suche nach passenden Stellen...</span>
                            </div>
                        )}

                        {isLoading && (
                            <div style={{
                                display: 'flex',
                                justifyContent: 'flex-start'
                            }}>
                                <div style={{
                                    padding: '12px 16px',
                                    borderRadius: '12px',
                                    backgroundColor: 'white',
                                    boxShadow: '0 2px 5px rgba(0,0,0,0.1)',
                                    color: '#666'
                                }}>
                                    Sam denkt nach...
                                </div>
                            </div>
                        )}

                        <div ref={messagesEndRef} />
                    </div>

                    {/* Input Area */}
                    <div style={{
                        padding: '20px',
                        backgroundColor: 'white',
                        borderTop: '1px solid #e0e0e0',
                        display: 'flex',
                        gap: '10px'
                    }}>
                        <input
                            ref={fileInputRef}
                            type="file"
                            accept=".pdf,.doc,.docx,.txt"
                            onChange={handleCVUpload}
                            style={{ display: 'none' }}
                        />
                        <button
                            onClick={() => fileInputRef.current?.click()}
                            disabled={isUploadingCV || isLoading}
                            style={{
                                padding: '12px 20px',
                                backgroundColor: isUploadingCV ? '#ccc' : '#667eea',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: isUploadingCV ? 'not-allowed' : 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px',
                                fontSize: '14px',
                                fontWeight: '500',
                                transition: 'background-color 0.2s'
                            }}
                            onMouseEnter={(e) => !isUploadingCV && (e.target.style.backgroundColor = '#5568d3')}
                            onMouseLeave={(e) => !isUploadingCV && (e.target.style.backgroundColor = '#667eea')}
                        >
                            <UploadIcon />
                            {isUploadingCV ? 'Lädt...' : 'CV hochladen'}
                        </button>
                        <input
                            type="text"
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                            placeholder="Nachricht an Sam..."
                            disabled={isLoading}
                            style={{
                                flex: 1,
                                padding: '12px 16px',
                                border: '1px solid #e0e0e0',
                                borderRadius: '8px',
                                fontSize: '14px',
                                outline: 'none'
                            }}
                        />
                        <button
                            onClick={sendMessage}
                            disabled={isLoading || !input.trim()}
                            style={{
                                padding: '12px 24px',
                                backgroundColor: (isLoading || !input.trim()) ? '#ccc' : '#667eea',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: (isLoading || !input.trim()) ? 'not-allowed' : 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px',
                                fontSize: '14px',
                                fontWeight: '500',
                                transition: 'background-color 0.2s'
                            }}
                            onMouseEnter={(e) => (!isLoading && input.trim()) && (e.target.style.backgroundColor = '#5568d3')}
                            onMouseLeave={(e) => (!isLoading && input.trim()) && (e.target.style.backgroundColor = '#667eea')}
                        >
                            <SendIcon />
                            Senden
                        </button>
                    </div>
                </div>
            );
        };

        // Render the app
        const root = createRoot(document.getElementById('root'));
        root.render(<SamCareerCoach />);
    </script>
</body>
</html>
