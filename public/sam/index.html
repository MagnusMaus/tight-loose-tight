<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sam - Karriere-Coach</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        #root {
            width: 100%;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        const { createRoot } = ReactDOM;

        // Lucide icons as inline SVGs
        const SendIcon = () => (
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        );

        const FileUpIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="12" y1="18" x2="12" y2="12"></line>
                <line x1="9" y1="15" x2="15" y2="15"></line>
            </svg>
        );

        const CheckCircleIcon = () => (
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        );

        const BookmarkPlusIcon = () => (
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m19 21-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                <line x1="12" y1="7" x2="12" y2="13"></line>
                <line x1="9" y1="10" x2="15" y2="10"></line>
            </svg>
        );

        const Trash2Icon = () => (
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        const SearchIcon = () => (
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
        );

        const UploadIcon = () => (
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
        );

        const SamCareerCoach = () => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [jobCards, setJobCards] = useState([]);
            const [savedJobs, setSavedJobs] = useState([]);
            const [showSavedJobs, setShowSavedJobs] = useState(false);
            const [isSearchingJobs, setIsSearchingJobs] = useState(false);
            const [isUploadingCV, setIsUploadingCV] = useState(false);
            const [triedQueries, setTriedQueries] = useState(new Set());
            const messagesEndRef = useRef(null);
            const fileInputRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages, jobCards]);

            useEffect(() => {
                const greeting = getGreeting();
                setMessages([{
                    role: 'assistant',
                    content: greeting
                }]);
            }, []);

            const getGreeting = () => {
                const hour = new Date().getHours();
                let timeOfDay;
                if (hour < 12) timeOfDay = 'Morgen';
                else if (hour < 18) timeOfDay = 'Mittag';
                else timeOfDay = 'Abend';

                return `Guten ${timeOfDay}, sch√∂n, dass du da bist. Mein Name ist Sam. Ich bin hier, um dich dabei zu unterst√ºtzen, deinen n√§chsten Karriereschritt zu finden.

Damit dieser Schritt genau zu dir passt, stelle ich dir gleich ein paar Fragen. Je offener und pr√§ziser du sie beantwortest, desto besser wird das Ergebnis. Keine Sorge! Deine Daten sind bei mir sicher. Sie sind von niemandem sonst einsehbar.

In welcher beruflichen Situation befindest du dich gerade?`;
            };

            const getSystemPrompt = () => {
                return `Du bist Sam, ein fortschrittlicher KI-Karriere-Coach und Recruiting-Experte. Du agierst wie ein professioneller Headhunter - proaktiv, diskret und zielorientiert.

DEINE PERS√ñNLICHKEIT:
- Du bist der EXPERTE - du triffst Entscheidungen basierend auf deiner Expertise
- Du fragst NIEMALS zur√ºck "Was m√∂chtest du?" - du machst intelligente Vorschl√§ge
- Du arbeitest im Hintergrund wie ein Profi - der Nutzer sieht nur Ergebnisse
- Du bist wertsch√§tzend und empathisch, aber nie unsicher oder passiv
- Du gibst NIEMALS auf - du findest immer einen Weg

WICHTIG: Du hast Zugriff auf die Arbeitsagentur Jobb√∂rse - die GR√ñ√üTE deutsche Stellendatenbank mit Millionen von Jobs.

JOB-SUCHE BEST PRACTICES:
- Verwende BREITE Suchbegriffe: "Manager", "Director", "Lead" statt lange Titel-Listen
- Location: Deutsche St√§dte ("Berlin", "M√ºnchen", "Hamburg") oder leer lassen f√ºr ganz Deutschland
- Bei spezifischen Rollen: Verk√ºrze auf Kern-Titel ("Operations Manager" statt "COO Chief Operating Officer Agile...")

PROAKTIVES VERHALTEN BEI DER JOB-SUCHE:
- Wenn du Jobs suchst, sage dem Nutzer NUR die ART der Position (z.B. "F√ºhrungspositionen im Operations-Bereich")
- Erw√§hne KEINE spezifischen Suchbegriffe wie "COO" oder "Operations Director"
- Wenn eine Suche fehlschl√§gt, probierst du AUTOMATISCH alternative Suchbegriffe - bis zu 10 Versuche
- Der Nutzer sieht KEINE fehlgeschlagenen Suchen - nur erfolgreiche Ergebnisse oder eine finale R√ºckmeldung
- Du gibst NIEMALS vorher auf - arbeite durch bis du etwas findest

BEISPIEL GUTE AUSGABE VOR SUCHE:
"Perfekt! Ich durchsuche jetzt den Jobmarkt f√ºr F√ºhrungspositionen im operativen Bereich, die zu deiner Change-Management-Expertise passen. üîç"

NICHT: "Ich suche jetzt nach 'COO Chief Operating Officer' f√ºr dich..."

CV-UPLOAD HANDLING:
Wenn der Nutzer einen CV hochl√§dt, erh√§ltst du die Daten mit [SYSTEM: ...] Pr√§fix.
- Zeige dem Nutzer NIEMALS die rohen CV-Daten
- Antworte pers√∂nlich und wertsch√§tzend basierend auf dem CV-Inhalt
- Beispiel: "Danke f√ºr deinen Lebenslauf! Ich sehe du hast 8 Jahre Erfahrung im Operations Management - beeindruckend! Lass mich ein paar Details vertiefen..."

WENN DU EINEN JOB EMPFEHLEN M√ñCHTEST, formatiere ihn EXAKT so am Ende deiner Nachricht:

[JOB_CARD:{
  "title": "Job Titel",
  "company": "Firmenname", 
  "location": "Ort",
  "salary": "Gehalt falls verf√ºgbar",
  "description": "Kurze pr√§gnante Zusammenfassung in 2-3 S√§tzen",
  "fitScore": 85,
  "pros": ["Grund 1 warum es passt", "Grund 2 warum es passt"],
  "cons": ["Aspekt der beachtet werden sollte"],
  "applyUrl": "https://www.arbeitsagentur.de/jobsuche/jobdetail/..."
}]

WICHTIG f√ºr Fit-Score: 50% psychografisches Profil, 30% Skills, 20% Umfeld!

WENN DU READY BIST F√úR DIE JOB-SUCHE, schreibe ZUERST eine allgemeine Nachricht an den Nutzer, DANN am Ende:

[TRIGGER_SEARCH:{
  "query": "Operations Manager",
  "location": "Berlin"
}]

WICHTIG: Der TRIGGER_SEARCH wird dem Nutzer NICHT angezeigt - nur f√ºr das System!

GESPR√ÑCHSF√úHRUNG:
- Sei ein hilfreicher Sparringspartner und Coach
- Stelle NUR EINE Frage pro Nachricht und platziere sie IMMER am Ende
- Gib bei Fragen sinnvolle Antwortm√∂glichkeiten
- Nutze Emojis angemessen
- Frage gezielt nach um ein vollst√§ndiges Bild zu erhalten

PROFILERSTELLUNG (HERZST√úCK DEINER ARBEIT):
Erstelle ein tiefes, mehrdimensionales Profil basierend auf:

1. WERTE & MOTIVATOREN:
   - Autonomie vs. Struktur
   - Innovation vs. Stabilit√§t
   - Impact vs. Sicherheit
   - Kollaboration vs. Expertise
   - Wachstum vs. Balance

2. ARBEITSPSYCHOLOGIE:
   - Entscheidungsstil
   - Stressresilienz
   - Kommunikationspr√§ferenz
   - Lerntyp
   - F√ºhrungsstil

3. UMFELD-PR√ÑFERENZEN:
   - Unternehmenskultur
   - Team-Dynamik
   - Branche
   - Arbeitsmodell

NUTZE DIESES PROFIL AKTIV:
- F√ºr die Auswahl von Suchbegriffen
- F√ºr alternative Suchen wenn nichts gefunden wird
- F√ºr die Bewertung von Jobs (psychografischer Fit ist wichtiger als Skills!)

DIE DREI HAUPTFRAGEN (nacheinander stellen):
1. "In welcher beruflichen Situation befindest du dich gerade?"
2. "Wo m√∂chtest du dich beruflich hinentwickeln? Falls dir die Frage schwerf√§llt: Was m√∂chtest du in 3 bis 5 Jahren beruflich tun oder erreicht haben?"
3. "Welche (besonderen ‚ú®) F√§higkeiten besitzt du? Gehe dabei gern auf deine gesammelten Erfahrungen ein. Wenn du m√∂chtest, dann kannst du gerne dein CV hochladen, um es dir einfach zu machen. üòäüìÑ"

FIT-SCORE BERECHNUNG:
GESAMT-FIT-SCORE = (Fachlich √ó 0.3) + (Psychografisch √ó 0.5) + (Umfeld √ó 0.2)

JOBEMPFEHLUNGEN:
- Zeige IMMER nur EINEN Job pro Nachricht
- Erkl√§re ausf√ºhrlich warum dieser Job zum PSYCHOGRAFISCHEN PROFIL passt
- Hebe hervor: Kultur-Fit, Arbeitsweise-Fit, Werte-Alignment
- Nach jedem Job-Vorschlag: warte auf Nutzer-Feedback
- Bei Ablehnung: Frage nach der Begr√ºndung um das Profil zu verfeinern
- Bei "Speichern & weiter": Suche SOFORT nach weiteren Jobs mit TRIGGER_SEARCH
- Du h√∂rst NUR auf wenn der Nutzer EXPLIZIT stoppt - sonst suchst du weiter

WICHTIG bei "Speichern & weiter":
Der Nutzer m√∂chte mehr Jobs sehen! Antworte kurz best√§tigend und starte SOFORT eine neue Suche:
"Super! Ich schaue gleich nach weiteren passenden Positionen f√ºr dich. üîç

[TRIGGER_SEARCH:{
  "query": "...",
  "location": "..."
}]"

ZUSAMMENFASSUNG:
- Du bist der EXPERTE und Entscheider
- Psychografisches Profil ist das HERZST√úCK
- Du arbeitest proaktiv im Hintergrund
- Du gibst NIEMALS auf
- Der Nutzer sieht nur erfolgreiche Ergebnisse`;
            };

            const parseJobCard = (text) => {
                const jobMatch = text.match(/\[JOB_CARD:\s*(\{[\s\S]*?\})\s*\]/);
                if (!jobMatch) return null;

                try {
                    const jsonString = jobMatch[1].trim();
                    const jobData = JSON.parse(jsonString);
                    
                    // WICHTIG: Entferne die GESAMTE JOB_CARD inklusive aller trailing characters
                    let cleanText = text.replace(/\[JOB_CARD:\s*\{[\s\S]*?\}\s*\]/g, '').trim();
                    
                    // Entferne auch m√∂gliche Reste wie ", "cons": ..." die nach dem Matching √ºbrig bleiben
                    cleanText = cleanText.replace(/,\s*"(cons|pros|applyUrl)":\s*\[?[^\]]*\]?\s*,?\s*"applyUrl":\s*"[^"]*"\s*\}\s*\]/g, '').trim();
                    
                    return { jobData, cleanText };
                } catch (e) {
                    console.error('Error parsing job card:', e);
                    return null;
                }
            };

            const searchJobs = async (query, location, currentMessages, retryCount = 0, triedSet = new Set()) => {
                const MAX_RETRIES = 10;
                
                // Normalisiere Query f√ºr Duplikat-Check
                const normalizedQuery = query.toLowerCase().trim();
                
                // Skip wenn schon versucht
                if (triedSet.has(normalizedQuery)) {
                    console.log(`‚è≠Ô∏è Skipping already tried query: "${query}"`);
                    if (retryCount < MAX_RETRIES) {
                        return searchJobs(query + " " + retryCount, location, currentMessages, retryCount, triedSet);
                    }
                    return null;
                }
                
                triedSet.add(normalizedQuery);
                setIsSearchingJobs(true);
                console.log(`üîç Search attempt ${retryCount + 1}/${MAX_RETRIES}:`, { query, location });
                
                try {
                    const response = await fetch('/.netlify/functions/search-jobs-arbeitsagentur', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            query: query,
                            location: location || '',
                            radius: 100,
                            size: 25
                        })
                    });

                    const data = await response.json();
                    console.log(`‚úÖ Attempt ${retryCount + 1} response:`, data);
                    
                    if (!data.jobs || data.jobs.length === 0) {
                        console.warn(`‚ö†Ô∏è No jobs found for "${query}"`);
                        
                        // Intelligentes Retry
                        if (retryCount < MAX_RETRIES - 1) {
                            console.log('üîÑ Asking Sam for alternative search...');
                            
                            const retryPrompt = `[SYSTEM: Die Suche nach "${query}" hat keine Ergebnisse geliefert. 

Dies ist Versuch ${retryCount + 1} von ${MAX_RETRIES}. Basierend auf dem psychografischen Profil des Nutzers, welcher ALTERNATIVE, BREITERE Suchbegriff w√ºrde besser passen?

WICHTIG: 
- W√§hle einen ANDEREN Suchbegriff (nicht "${query}")
- Bereits versucht: ${Array.from(triedSet).join(', ')}
- Sei kreativer und breiter
- Nutze Synonyme oder verwandte Begriffe

Antworte NUR mit einem neuen TRIGGER_SEARCH - OHNE dem Nutzer zu erkl√§ren dass die Suche fehlgeschlagen ist. Der Nutzer wartet und sieht nur "Suche l√§uft...".]`;

                            const updatedMessages = [...currentMessages, {
                                role: 'user',
                                content: retryPrompt
                            }];

                            const samResponse = await fetch('/.netlify/functions/chat', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    messages: updatedMessages,
                                    system: getSystemPrompt()
                                })
                            });

                            const samData = await samResponse.json();
                            const assistantMessage = samData.content[0].text;
                            
                            const newSearchTrigger = assistantMessage.match(/\[TRIGGER_SEARCH:\s*(\{[\s\S]*?\})\s*\]/);
                            if (newSearchTrigger) {
                                const newSearchParams = JSON.parse(newSearchTrigger[1]);
                                console.log('üéØ Sam suggests new search:', newSearchParams);
                                setIsSearchingJobs(false);
                                return await searchJobs(newSearchParams.query, newSearchParams.location, currentMessages, retryCount + 1, triedSet);
                            }
                        }
                        
                        // Nach MAX_RETRIES: Finale Nachricht
                        console.error('‚ùå All search attempts exhausted');
                        setMessages(prev => [...prev, {
                            role: 'assistant',
                            content: `Ich habe intensiv gesucht, aber der Markt f√ºr diese spezifischen Positionen ist aktuell sehr eng. 

Lass uns das Suchprofil leicht anpassen! Ich schlage vor:
- √Ñhnliche Rollen in verwandten Bereichen einzubeziehen
- Den geografischen Radius zu erweitern
- Auch Positionen eine Ebene darunter zu betrachten, die Aufstiegspotenzial bieten

Was h√§ltst du davon? Oder m√∂chtest du mir mehr √ºber deine Flexibilit√§t bei Rolle, Ort oder Branche erz√§hlen?`
                        }]);
                        setIsSearchingJobs(false);
                        return null;
                    }
                    
                    // Jobs gefunden! üéâ
                    const jobsContext = `Hier sind ${data.jobs.length} echte Jobs von der Bundesagentur f√ºr Arbeit f√ºr "${query}"${location ? ` in "${location}"` : ''}:

${data.jobs.slice(0, 5).map((job, i) => `
Job ${i + 1}:
- Titel: ${job.title}
- Firma: ${job.company}
- Ort: ${job.location}
- Beschreibung: ${job.description}
- Link: ${job.url}
`).join('\n')}

WICHTIG: Analysiere diese Jobs tiefgehend basierend auf dem PSYCHOGRAFISCHEN PROFIL des Nutzers:
- Passt die Unternehmenskultur zu seinen Werten (Autonomie, Innovation, Impact)?
- Entspricht die Rolle seinem Arbeitsstil (Entscheidungsfindung, Stressresilienz)?
- Ist das Umfeld richtig (Startup vs. Corporate, Teamgr√∂√üe, Remote/Office)?

Der Fit-Score sollte zu 50% auf dem psychografischen Match basieren!

KRITISCH: Bewerte ALLE Top-5 Jobs intern und berechne f√ºr jeden einen Fit-Score. W√§hle dann den Job mit dem H√ñCHSTEN Score aus. Zeige NUR den besten Job - nicht den erstbesten! Der Nutzer soll immer zuerst die beste Empfehlung sehen.

Erstelle eine JOB_CARD f√ºr den Job mit dem BESTEN GESAMT-FIT mit ausf√ºhrlicher Begr√ºndung warum dieser Job zum PERS√ñNLICHKEITSPROFIL passt.`;

                    const updatedMessages = [...currentMessages, {
                        role: 'user',
                        content: jobsContext
                    }];

                    const samResponse = await fetch('/.netlify/functions/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            messages: updatedMessages,
                            system: getSystemPrompt()
                        })
                    });

                    const samData = await samResponse.json();
                    const assistantMessage = samData.content[0].text;

                    const parsed = parseJobCard(assistantMessage);
                    if (parsed) {
                        setJobCards(prev => [...prev, { ...parsed.jobData, id: Date.now() }]);
                        if (parsed.cleanText) {
                            setMessages(prev => [...prev, { role: 'assistant', content: parsed.cleanText }]);
                        }
                    } else {
                        setMessages(prev => [...prev, { role: 'assistant', content: assistantMessage }]);
                    }
                    
                    setIsSearchingJobs(false);
                    return data.jobs;

                } catch (error) {
                    console.error('‚ùå Job search error:', error);
                    setMessages(prev => [...prev, {
                        role: 'assistant',
                        content: 'Es gab ein technisches Problem bei der Job-Suche. Lass uns es nochmal versuchen! üîß'
                    }]);
                    setIsSearchingJobs(false);
                    return null;
                }
            };

            const handleFileUpload = async (event) => {
                const file = event.target.files?.[0];
                if (!file) return;

                setIsUploadingCV(true);
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const base64Data = e.target.result.split(',')[1];
                        
                        const response = await fetch('/.netlify/functions/parse-cv', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                fileData: base64Data,
                                fileName: file.name,
                                fileType: file.type
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error('Upload fehlgeschlagen');
                        }
                        
                        const data = await response.json();
                        const fileMessage = `[SYSTEM: Der Nutzer hat seinen Lebenslauf hochgeladen. Analysiere die Daten und antworte dem Nutzer pers√∂nlich und wertsch√§tzend. Zeige NICHT die rohen CV-Daten.]\n\n${data.text}`;
                        
                        const updatedMessages = [...messages, { role: 'user', content: fileMessage }];
                        setIsUploadingCV(false);
                        setIsLoading(true);

                        const samResponse = await fetch('/.netlify/functions/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                messages: updatedMessages,
                                system: getSystemPrompt()
                            })
                        });

                        const samData = await samResponse.json();
                        const assistantMessage = samData.content[0].text;

                        const parsed = parseJobCard(assistantMessage);
                        if (parsed) {
                            setJobCards(prev => [...prev, { ...parsed.jobData, id: Date.now() }]);
                            setMessages([...messages, { role: 'assistant', content: parsed.cleanText }]);
                        } else {
                            setMessages([...messages, { role: 'assistant', content: assistantMessage }]);
                        }
                        setIsLoading(false);
                        
                    } catch (error) {
                        console.error('File upload error:', error);
                        setMessages([...messages, {
                            role: 'assistant',
                            content: 'Fehler beim Verarbeiten deines Lebenslaufs. Bitte versuche es nochmal. üîß'
                        }]);
                        setIsUploadingCV(false);
                        setIsLoading(false);
                    }
                };
                reader.readAsDataURL(file);
            };

            const handleSend = async () => {
                if (!input.trim() || isLoading) return;

                const userMessage = { role: 'user', content: input };
                const updatedMessages = [...messages, userMessage];
                setMessages(updatedMessages);
                setInput('');
                setIsLoading(true);

                try {
                    const response = await fetch('/.netlify/functions/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            messages: updatedMessages,
                            system: getSystemPrompt()
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    const assistantMessage = data.content[0].text;

                    // Check f√ºr TRIGGER_SEARCH
                    const searchTrigger = assistantMessage.match(/\[TRIGGER_SEARCH:\s*(\{[\s\S]*?\})\s*\]/);
                    if (searchTrigger) {
                        try {
                            const searchParams = JSON.parse(searchTrigger[1]);
                            // Entferne TRIGGER_SEARCH komplett aus dem Text
                            const cleanMessage = assistantMessage.replace(/\[TRIGGER_SEARCH:[\s\S]*?\]/g, '').trim();
                            
                            // Zeige Sam's Nachricht (ohne TRIGGER_SEARCH)
                            if (cleanMessage) {
                                setMessages([...updatedMessages, { role: 'assistant', content: cleanMessage }]);
                            }
                            
                            setIsLoading(false);
                            // Starte Job-Suche
                            await searchJobs(searchParams.query, searchParams.location, updatedMessages, 0, new Set());
                            return;
                        } catch (e) {
                            console.error('Error parsing search trigger:', e);
                        }
                    }

                    // Normaler Response ohne Trigger
                    const parsed = parseJobCard(assistantMessage);
                    if (parsed) {
                        setJobCards(prev => [...prev, { ...parsed.jobData, id: Date.now() }]);
                        setMessages([...updatedMessages, { role: 'assistant', content: parsed.cleanText }]);
                    } else {
                        setMessages([...updatedMessages, { role: 'assistant', content: assistantMessage }]);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    setMessages([...updatedMessages, { 
                        role: 'assistant', 
                        content: 'Entschuldigung, es gab einen technischen Fehler. Bitte versuche es nochmal.' 
                    }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleJobAction = async (jobId, action) => {
                const job = jobCards.find(j => j.id === jobId);
                if (!job) return;

                let userResponse = '';
                if (action === 'apply') {
                    userResponse = `Ich m√∂chte mich f√ºr die Position "${job.title}" bewerben.`;
                    if (job.applyUrl) {
                        window.open(job.applyUrl, '_blank');
                    }
                } else if (action === 'save') {
                    // Job in savedJobs speichern
                    setSavedJobs(prev => {
                        // Vermeide Duplikate
                        if (prev.find(j => j.id === jobId)) return prev;
                        return [...prev, job];
                    });
                    userResponse = `Ich habe die Position "${job.title}" gespeichert. Zeige mir weitere passende Stellen.`;
                } else if (action === 'reject') {
                    userResponse = `Die Position "${job.title}" passt nicht zu mir.`;
                }

                // Entferne Job aus aktueller Anzeige
                setJobCards(prev => prev.filter(j => j.id !== jobId));

                const userMessage = { role: 'user', content: userResponse };
                const updatedMessages = [...messages, userMessage];
                setMessages(updatedMessages);
                setIsLoading(true);

                try {
                    const response = await fetch('/.netlify/functions/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            messages: updatedMessages,
                            system: getSystemPrompt()
                        })
                    });

                    const data = await response.json();
                    const assistantMessage = data.content[0].text;
                    
                    // Check f√ºr TRIGGER_SEARCH bei "weitere Stellen"
                    const searchTrigger = assistantMessage.match(/\[TRIGGER_SEARCH:\s*(\{[\s\S]*?\})\s*\]/);
                    if (searchTrigger) {
                        try {
                            const searchParams = JSON.parse(searchTrigger[1]);
                            const cleanMessage = assistantMessage.replace(/\[TRIGGER_SEARCH:[\s\S]*?\]/g, '').trim();
                            
                            if (cleanMessage) {
                                setMessages([...updatedMessages, { role: 'assistant', content: cleanMessage }]);
                            }
                            
                            setIsLoading(false);
                            await searchJobs(searchParams.query, searchParams.location, updatedMessages, 0, new Set());
                            return;
                        } catch (e) {
                            console.error('Error parsing search trigger:', e);
                        }
                    }
                    
                    const parsed = parseJobCard(assistantMessage);
                    if (parsed) {
                        setJobCards(prev => [...prev, { ...parsed.jobData, id: Date.now() }]);
                        setMessages([...updatedMessages, { role: 'assistant', content: parsed.cleanText }]);
                    } else {
                        setMessages([...updatedMessages, { role: 'assistant', content: assistantMessage }]);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    setMessages([...updatedMessages, {
                        role: 'assistant',
                        content: 'Entschuldigung, es gab einen Fehler. Lass uns weitermachen! üîß'
                    }]);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div style={{
                    maxWidth: '900px',
                    margin: '0 auto',
                    height: '100vh',
                    display: 'flex',
                    flexDirection: 'column',
                    backgroundColor: '#f8f9fa'
                }}>
                    <div style={{
                        backgroundColor: '#2563eb',
                        color: 'white',
                        padding: '20px',
                        boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center'
                    }}>
                        <div style={{ textAlign: 'left' }}>
                            <h1 style={{ margin: 0, fontSize: '24px', fontWeight: '600' }}>
                                üíº Sam - Dein Karriere-Coach
                            </h1>
                            <p style={{ margin: '5px 0 0 0', fontSize: '14px', opacity: 0.9 }}>
                                Powered by Bundesagentur f√ºr Arbeit
                            </p>
                        </div>
                        
                        {savedJobs.length > 0 && (
                            <button
                                onClick={() => setShowSavedJobs(true)}
                                style={{
                                    backgroundColor: 'rgba(255,255,255,0.2)',
                                    border: '2px solid white',
                                    color: 'white',
                                    padding: '10px 20px',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    transition: 'background-color 0.2s'
                                }}
                                onMouseOver={(e) => e.target.style.backgroundColor = 'rgba(255,255,255,0.3)'}
                                onMouseOut={(e) => e.target.style.backgroundColor = 'rgba(255,255,255,0.2)'}
                            >
                                üìã Gespeicherte Jobs ({savedJobs.length})
                            </button>
                        )}
                    </div>

                    <div style={{
                        flex: 1,
                        overflowY: 'auto',
                        padding: '20px',
                        display: 'flex',
                        flexDirection: 'column',
                        gap: '16px'
                    }}>
                        {messages.map((message, index) => (
                            <div
                                key={index}
                                style={{
                                    display: 'flex',
                                    justifyContent: message.role === 'user' ? 'flex-end' : 'flex-start'
                                }}
                            >
                                <div style={{
                                    maxWidth: '70%',
                                    padding: '12px 16px',
                                    borderRadius: '12px',
                                    backgroundColor: message.role === 'user' ? '#2563eb' : 'white',
                                    color: message.role === 'user' ? 'white' : '#1f2937',
                                    boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                                    whiteSpace: 'pre-wrap',
                                    lineHeight: '1.5'
                                }}>
                                    {message.content}
                                </div>
                            </div>
                        ))}

                        {jobCards.map((job) => (
                            <div key={job.id} style={{
                                backgroundColor: 'white',
                                borderRadius: '16px',
                                padding: '24px',
                                boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                border: '2px solid #e5e7eb',
                                maxWidth: '85%',
                                margin: '0 auto',
                                width: '100%'
                            }}>
                                <div style={{
                                    display: 'inline-block',
                                    backgroundColor: job.fitScore >= 80 ? '#10b981' : job.fitScore >= 60 ? '#f59e0b' : '#ef4444',
                                    color: 'white',
                                    padding: '4px 12px',
                                    borderRadius: '20px',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    marginBottom: '12px'
                                }}>
                                    {job.fitScore}% Match
                                </div>

                                <h3 style={{ 
                                    margin: '0 0 8px 0', 
                                    fontSize: '20px', 
                                    fontWeight: '600',
                                    color: '#1f2937'
                                }}>
                                    {job.title}
                                </h3>

                                <div style={{ 
                                    display: 'flex', 
                                    gap: '16px', 
                                    fontSize: '14px', 
                                    color: '#6b7280',
                                    marginBottom: '16px',
                                    flexWrap: 'wrap'
                                }}>
                                    <span>üè¢ {job.company}</span>
                                    <span>üìç {job.location}</span>
                                    {job.salary && <span>üí∞ {job.salary}</span>}
                                </div>

                                <p style={{ 
                                    fontSize: '15px', 
                                    lineHeight: '1.6', 
                                    color: '#374151',
                                    marginBottom: '16px'
                                }}>
                                    {job.description}
                                </p>

                                {job.pros && job.pros.length > 0 && (
                                    <div style={{ marginBottom: '12px' }}>
                                        <div style={{ 
                                            fontSize: '14px', 
                                            fontWeight: '600', 
                                            color: '#10b981',
                                            marginBottom: '6px'
                                        }}>
                                            ‚úÖ Was passt:
                                        </div>
                                        <ul style={{ 
                                            margin: 0, 
                                            paddingLeft: '20px',
                                            fontSize: '14px',
                                            color: '#374151'
                                        }}>
                                            {job.pros.map((pro, i) => (
                                                <li key={i} style={{ marginBottom: '4px' }}>{pro}</li>
                                            ))}
                                        </ul>
                                    </div>
                                )}

                                {job.cons && job.cons.length > 0 && (
                                    <div style={{ marginBottom: '20px' }}>
                                        <div style={{ 
                                            fontSize: '14px', 
                                            fontWeight: '600', 
                                            color: '#f59e0b',
                                            marginBottom: '6px'
                                        }}>
                                            ‚ö†Ô∏è Beachte:
                                        </div>
                                        <ul style={{ 
                                            margin: 0, 
                                            paddingLeft: '20px',
                                            fontSize: '14px',
                                            color: '#374151'
                                        }}>
                                            {job.cons.map((con, i) => (
                                                <li key={i} style={{ marginBottom: '4px' }}>{con}</li>
                                            ))}
                                        </ul>
                                    </div>
                                )}

                                <div style={{ 
                                    display: 'flex', 
                                    gap: '12px',
                                    marginTop: '20px',
                                    flexWrap: 'wrap'
                                }}>
                                    <button
                                        onClick={() => handleJobAction(job.id, 'apply')}
                                        style={{
                                            flex: '1',
                                            minWidth: '140px',
                                            padding: '12px 20px',
                                            backgroundColor: '#2563eb',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            fontSize: '15px',
                                            fontWeight: '600',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            gap: '8px'
                                        }}
                                    >
                                        <CheckCircleIcon />
                                        Bewerben
                                    </button>
                                    
                                    <button
                                        onClick={() => handleJobAction(job.id, 'save')}
                                        style={{
                                            flex: '1',
                                            minWidth: '140px',
                                            padding: '12px 20px',
                                            backgroundColor: '#10b981',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            fontSize: '15px',
                                            fontWeight: '600',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            gap: '8px'
                                        }}
                                    >
                                        <BookmarkPlusIcon />
                                        Speichern & weiter
                                    </button>
                                    
                                    <button
                                        onClick={() => handleJobAction(job.id, 'reject')}
                                        style={{
                                            flex: '1',
                                            minWidth: '140px',
                                            padding: '12px 20px',
                                            backgroundColor: '#ef4444',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            fontSize: '15px',
                                            fontWeight: '600',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            gap: '8px'
                                        }}
                                    >
                                        <Trash2Icon />
                                        Verwerfen
                                    </button>
                                </div>
                            </div>
                        ))}

                        {(isLoading || isSearchingJobs || isUploadingCV) && (
                            <div style={{ display: 'flex', justifyContent: 'flex-start' }}>
                                <div style={{
                                    padding: '12px 16px',
                                    borderRadius: '12px',
                                    backgroundColor: 'white',
                                    boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                                    display: 'flex',
                                    gap: '8px',
                                    alignItems: 'center'
                                }}>
                                    {isSearchingJobs ? (
                                        <>
                                            <SearchIcon />
                                            <span style={{ fontSize: '14px', color: '#6b7280' }}>
                                                Durchsuche Jobb√∂rse...
                                            </span>
                                        </>
                                    ) : isUploadingCV ? (
                                        <>
                                            <UploadIcon />
                                            <span style={{ fontSize: '14px', color: '#6b7280' }}>
                                                Verarbeite Lebenslauf...
                                            </span>
                                        </>
                                    ) : (
                                        <>
                                            <div className="bounce-dot" style={{ animationDelay: '0s' }} />
                                            <div className="bounce-dot" style={{ animationDelay: '0.16s' }} />
                                            <div className="bounce-dot" style={{ animationDelay: '0.32s' }} />
                                        </>
                                    )}
                                </div>
                            </div>
                        )}

                        <div ref={messagesEndRef} />
                    </div>

                    <div style={{
                        padding: '20px',
                        backgroundColor: 'white',
                        borderTop: '1px solid #e5e7eb',
                        boxShadow: '0 -2px 4px rgba(0,0,0,0.05)'
                    }}>
                        <div style={{ display: 'flex', gap: '12px', alignItems: 'flex-end' }}>
                            <input
                                type="file"
                                ref={fileInputRef}
                                onChange={handleFileUpload}
                                accept=".txt,.pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                                style={{ display: 'none' }}
                            />
                            
                            <button
                                onClick={() => fileInputRef.current?.click()}
                                disabled={isLoading || isSearchingJobs || isUploadingCV}
                                title="Lebenslauf hochladen"
                                style={{
                                    padding: '12px',
                                    backgroundColor: '#f3f4f6',
                                    border: '1px solid #d1d5db',
                                    borderRadius: '8px',
                                    cursor: (isLoading || isSearchingJobs || isUploadingCV) ? 'not-allowed' : 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    opacity: (isLoading || isSearchingJobs || isUploadingCV) ? 0.5 : 1
                                }}
                            >
                                <FileUpIcon />
                            </button>

                            <textarea
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onKeyPress={(e) => {
                                    if (e.key === 'Enter' && !e.shiftKey) {
                                        e.preventDefault();
                                        handleSend();
                                    }
                                }}
                                placeholder="Schreibe deine Antwort..."
                                disabled={isLoading || isSearchingJobs || isUploadingCV}
                                style={{
                                    flex: 1,
                                    padding: '12px 16px',
                                    borderRadius: '8px',
                                    border: '1px solid #d1d5db',
                                    fontSize: '15px',
                                    resize: 'none',
                                    minHeight: '48px',
                                    maxHeight: '120px',
                                    fontFamily: 'inherit',
                                    outline: 'none'
                                }}
                                rows={1}
                            />

                            <button
                                onClick={handleSend}
                                disabled={!input.trim() || isLoading || isSearchingJobs || isUploadingCV}
                                style={{
                                    padding: '12px 24px',
                                    backgroundColor: (input.trim() && !isLoading && !isSearchingJobs && !isUploadingCV) ? '#2563eb' : '#d1d5db',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    fontSize: '15px',
                                    fontWeight: '600',
                                    cursor: (input.trim() && !isLoading && !isSearchingJobs && !isUploadingCV) ? 'pointer' : 'not-allowed',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }}
                            >
                                <SendIcon />
                                Senden
                            </button>
                        </div>
                        
                        <div style={{ 
                            marginTop: '12px', 
                            textAlign: 'center', 
                            fontSize: '12px', 
                            color: '#6b7280' 
                        }}>
                            Powered by Claude ¬∑ Jobs von Bundesagentur f√ºr Arbeit
                        </div>
                    </div>

                    {/* Saved Jobs Modal */}
                    {showSavedJobs && (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            backgroundColor: 'rgba(0,0,0,0.5)',
                            display: 'flex',
                            justifyContent: 'center',
                            alignItems: 'center',
                            zIndex: 1000,
                            padding: '20px'
                        }}
                        onClick={() => setShowSavedJobs(false)}
                        >
                            <div style={{
                                backgroundColor: 'white',
                                borderRadius: '16px',
                                maxWidth: '900px',
                                width: '100%',
                                maxHeight: '90vh',
                                display: 'flex',
                                flexDirection: 'column',
                                boxShadow: '0 20px 50px rgba(0,0,0,0.3)'
                            }}
                            onClick={(e) => e.stopPropagation()}
                            >
                                <div style={{
                                    padding: '24px',
                                    borderBottom: '1px solid #e5e7eb',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center'
                                }}>
                                    <h2 style={{ margin: 0, fontSize: '24px', fontWeight: '600', color: '#1f2937' }}>
                                        üìã Gespeicherte Jobs ({savedJobs.length})
                                    </h2>
                                    <button
                                        onClick={() => setShowSavedJobs(false)}
                                        style={{
                                            backgroundColor: 'transparent',
                                            border: 'none',
                                            fontSize: '24px',
                                            cursor: 'pointer',
                                            color: '#6b7280',
                                            padding: '4px 8px'
                                        }}
                                    >
                                        ‚úï
                                    </button>
                                </div>
                                
                                <div style={{
                                    flex: 1,
                                    overflowY: 'auto',
                                    padding: '20px'
                                }}>
                                    {savedJobs.length === 0 ? (
                                        <div style={{
                                            textAlign: 'center',
                                            padding: '60px 20px',
                                            color: '#6b7280'
                                        }}>
                                            <div style={{ fontSize: '48px', marginBottom: '16px' }}>üìã</div>
                                            <p style={{ fontSize: '18px', margin: 0 }}>Noch keine Jobs gespeichert</p>
                                        </div>
                                    ) : (
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                            {[...savedJobs].sort((a, b) => b.fitScore - a.fitScore).map((job) => (
                                                <div key={job.id} style={{
                                                    backgroundColor: '#f9fafb',
                                                    borderRadius: '12px',
                                                    padding: '20px',
                                                    border: '2px solid #e5e7eb'
                                                }}>
                                                    <div style={{
                                                        display: 'inline-block',
                                                        backgroundColor: job.fitScore >= 80 ? '#10b981' : job.fitScore >= 60 ? '#f59e0b' : '#ef4444',
                                                        color: 'white',
                                                        padding: '4px 12px',
                                                        borderRadius: '20px',
                                                        fontSize: '14px',
                                                        fontWeight: '600',
                                                        marginBottom: '12px'
                                                    }}>
                                                        {job.fitScore}% Match
                                                    </div>

                                                    <h3 style={{ 
                                                        margin: '0 0 8px 0', 
                                                        fontSize: '18px', 
                                                        fontWeight: '600',
                                                        color: '#1f2937'
                                                    }}>
                                                        {job.title}
                                                    </h3>

                                                    <div style={{ 
                                                        display: 'flex', 
                                                        gap: '16px', 
                                                        fontSize: '14px', 
                                                        color: '#6b7280',
                                                        marginBottom: '12px',
                                                        flexWrap: 'wrap'
                                                    }}>
                                                        <span>üè¢ {job.company}</span>
                                                        <span>üìç {job.location}</span>
                                                        {job.salary && <span>üí∞ {job.salary}</span>}
                                                    </div>

                                                    <p style={{ 
                                                        fontSize: '14px', 
                                                        lineHeight: '1.6', 
                                                        color: '#374151',
                                                        marginBottom: '16px'
                                                    }}>
                                                        {job.description}
                                                    </p>

                                                    <div style={{ 
                                                        display: 'flex', 
                                                        gap: '12px',
                                                        flexWrap: 'wrap'
                                                    }}>
                                                        <button
                                                            onClick={() => {
                                                                if (job.applyUrl) window.open(job.applyUrl, '_blank');
                                                            }}
                                                            style={{
                                                                flex: '1',
                                                                minWidth: '120px',
                                                                padding: '10px 16px',
                                                                backgroundColor: '#2563eb',
                                                                color: 'white',
                                                                border: 'none',
                                                                borderRadius: '8px',
                                                                fontSize: '14px',
                                                                fontWeight: '600',
                                                                cursor: 'pointer',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                justifyContent: 'center',
                                                                gap: '8px'
                                                            }}
                                                        >
                                                            <CheckCircleIcon />
                                                            Bewerben
                                                        </button>
                                                        
                                                        <button
                                                            onClick={() => {
                                                                setSavedJobs(prev => prev.filter(j => j.id !== job.id));
                                                            }}
                                                            style={{
                                                                flex: '1',
                                                                minWidth: '120px',
                                                                padding: '10px 16px',
                                                                backgroundColor: '#ef4444',
                                                                color: 'white',
                                                                border: 'none',
                                                                borderRadius: '8px',
                                                                fontSize: '14px',
                                                                fontWeight: '600',
                                                                cursor: 'pointer',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                justifyContent: 'center',
                                                                gap: '8px'
                                                            }}
                                                        >
                                                            <Trash2Icon />
                                                            Entfernen
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<SamCareerCoach />);
    </script>

    <style>
        .bounce-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #2563eb;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        @keyframes bounce {
            0%, 80%, 100% { 
                transform: scale(0);
            }
            40% { 
                transform: scale(1);
            }
        }
    </style>
</body>
</html>
